generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String     @id @default(cuid())        @map("id")
  email         String     @unique                    @map("email")
  username      String?    @unique                    @map("username")
  passwordHash  String                                 @map("password_hash")
  name          String?                                @map("name")
  status        UserStatus @default(pending)           @map("status")
  createdAt     DateTime   @default(now())            @map("created_at")
  updatedAt     DateTime   @updatedAt                 @map("updated_at")
  roles     UserRole[]

  @@map("users")
}

model Role {
  id          String          @id @default(cuid())   @map("id")
  name        String          @unique                @map("name")
  system      Boolean         @default(false)        @map("system")
  users       UserRole[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id       String           @id @default(cuid())       @map("id")
  name     String           @unique                    @map("name")
  resource String                                      @map("resource")
  action   String                                      @map("action")
  description String?                                  @map("description")
  system   Boolean          @default(false)            @map("system")
  roles    RolePermission[]
  
  @@unique([resource, action])
  @@map("permissions")
}

model UserRole {
  userId String @map("user_id")
  roleId String @map("role_id")
  user   User @relation(fields: [userId], references: [id])
  role   Role @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  roleId       String @map("role_id")
  permissionId String @map("permission_id")
  role         Role       @relation(fields: [roleId], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// Domain models
model Credential {
  id         Int      @id @default(autoincrement()) @map("id")
  name       String                               @map("name")
  type       String                               @map("type")
  data       Json                                 @map("data")
  createdAt  DateTime @default(now())             @map("created_at")
  services   Service[]

  @@map("credentials")
}

enum ServerType {
  os
  rds
  amplify
  lambda
  ec2
  ecs
  other
}

model Server {
  id         Int        @id @default(autoincrement()) @map("id")
  name       String                                   @map("name")
  type       ServerType @default(os)                 @map("type")
  publicIp   String?                                  @map("public_ip")
  privateIp  String?                                  @map("private_ip")
  endpoint   String?                                  @map("endpoint")
  sshPort    Int?                                     @map("ssh_port")
  username   String?                                  @map("username")
  password   String?                                  @map("password")
  createdAt  DateTime   @default(now())               @map("created_at")
  services   Service[]
  tags       ServerTag[]

  @@map("servers")
}

model Service {
  id             Int         @id @default(autoincrement()) @map("id")
  name           String                                   @map("name")
  port           Int                                      @map("port")
  sourceRepo     String?                                  @map("source_repo")
  appId          String?                                  @map("app_id")
  functionName   String?                                  @map("function_name")
  deploymentUrl  String?                                  @map("deployment_url")
  metadata       Json?                                    @map("metadata")
  createdAt      DateTime    @default(now())              @map("created_at")
  serverId       Int                                      @map("server_id")
  server         Server      @relation(fields: [serverId], references: [id])
  credentialId   Int?                                     @map("credential_id")
  credential     Credential? @relation(fields: [credentialId], references: [id])
  tags           ServiceTag[]
  releaseNotes   ReleaseNote[]

  @@map("services")
}

enum GroupItemType {
  server
  service
}

model Group {
  id        Int         @id @default(autoincrement()) @map("id")
  name      String      @unique                       @map("name")
  createdAt DateTime    @default(now())               @map("created_at")
  items     GroupItem[]

  @@map("groups")
}

model GroupItem {
  id        Int           @id @default(autoincrement()) @map("id")
  groupId   Int                                       @map("group_id")
  group     Group         @relation(fields: [groupId], references: [id])
  itemType  GroupItemType                             @map("item_type")
  itemId    Int                                       @map("item_id")

  @@map("group_items")
}

model Tag {
  id        Int       @id @default(autoincrement()) @map("id")
  name      String                                  @map("name")
  value     String?                                 @map("value")
  createdAt DateTime  @default(now())              @map("created_at")
  services  ServiceTag[]
  servers   ServerTag[]

  @@unique([name, value])
  @@map("tags")
}

model ServiceTag {
  serviceId Int @map("service_id")
  tagId     Int @map("tag_id")
  service   Service @relation(fields: [serviceId], references: [id])
  tag       Tag     @relation(fields: [tagId], references: [id])

  @@id([serviceId, tagId])
  @@map("service_tags")
}

model ServerTag {
  serverId Int @map("server_id")
  tagId    Int @map("tag_id")
  server   Server @relation(fields: [serverId], references: [id])
  tag      Tag    @relation(fields: [tagId], references: [id])

  @@id([serverId, tagId])
  @@map("server_tags")
}

enum ReleaseStatus {
  pending
  deployed
}

enum UserStatus {
  pending
  approved
  blocked
}

model ReleaseNote {
  id         Int            @id @default(autoincrement()) @map("id")
  serviceId  Int                                         @map("service_id")
  service    Service        @relation(fields: [serviceId], references: [id])
  note       String                                      @map("note")
  status     ReleaseStatus  @default(pending)            @map("status")
  createdAt  DateTime       @default(now())              @map("created_at")
  updatedAt  DateTime       @updatedAt                   @map("updated_at")

  @@map("release_notes")
}

model Domain {
  id        Int       @id @default(autoincrement()) @map("id")
  name      String    @unique                       @map("name")
  createdAt DateTime  @default(now())               @map("created_at")
  updatedAt DateTime  @updatedAt                   @map("updated_at")

  @@map("domains")
}
